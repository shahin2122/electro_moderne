import { Inject, Injectable, Optional } from '@angular/core';
import * as i0 from "@angular/core";
export class GoogleTagManagerService {
    constructor(config = { id: null }, googleTagManagerId, googleTagManagerAuth, googleTagManagerPreview, googleTagManagerResourcePath, googleTagManagerCSPNonce) {
        this.config = config;
        this.googleTagManagerId = googleTagManagerId;
        this.googleTagManagerAuth = googleTagManagerAuth;
        this.googleTagManagerPreview = googleTagManagerPreview;
        this.googleTagManagerResourcePath = googleTagManagerResourcePath;
        this.googleTagManagerCSPNonce = googleTagManagerCSPNonce;
        this.isLoaded = false;
        this.browserGlobals = {
            windowRef() {
                return window;
            },
            documentRef() {
                return document;
            },
        };
        if (this.config == null) {
            this.config = { id: null };
        }
        this.config = Object.assign(Object.assign({}, this.config), { id: googleTagManagerId || this.config.id, gtm_auth: googleTagManagerAuth || this.config.gtm_auth, gtm_preview: googleTagManagerPreview || this.config.gtm_preview, gtm_resource_path: googleTagManagerResourcePath || this.config.gtm_resource_path });
        if (this.config.id == null) {
            throw new Error('Google tag manager ID not provided.');
        }
    }
    getDataLayer() {
        const window = this.browserGlobals.windowRef();
        window.dataLayer = window.dataLayer || [];
        return window.dataLayer;
    }
    pushOnDataLayer(obj) {
        const dataLayer = this.getDataLayer();
        dataLayer.push(obj);
    }
    addGtmToDom() {
        return new Promise((resolve, reject) => {
            if (this.isLoaded) {
                return resolve(this.isLoaded);
            }
            const doc = this.browserGlobals.documentRef();
            this.pushOnDataLayer({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js',
            });
            const gtmScript = doc.createElement('script');
            gtmScript.id = 'GTMscript';
            gtmScript.async = true;
            gtmScript.src = this.applyGtmQueryParams(this.config.gtm_resource_path ? this.config.gtm_resource_path : 'https://www.googletagmanager.com/gtm.js');
            gtmScript.addEventListener('load', () => {
                return resolve(this.isLoaded = true);
            });
            gtmScript.addEventListener('error', () => {
                return reject(false);
            });
            if (this.googleTagManagerCSPNonce) {
                gtmScript.setAttribute('nonce', this.googleTagManagerCSPNonce);
            }
            doc.head.insertBefore(gtmScript, doc.head.firstChild);
        });
    }
    pushTag(item) {
        return new Promise((resolve, reject) => {
            if (!this.isLoaded) {
                this.addGtmToDom().then(() => {
                    this.pushOnDataLayer(item);
                    return resolve();
                }).catch(() => reject());
            }
            else {
                this.pushOnDataLayer(item);
                return resolve();
            }
        });
    }
    applyGtmQueryParams(url) {
        if (url.indexOf('?') === -1) {
            url += '?';
        }
        return (url +
            Object.keys(this.config)
                .filter((k) => this.config[k])
                .map((k) => `${k}=${this.config[k]}`)
                .join('&'));
    }
}
/** @nocollapse */ GoogleTagManagerService.ɵprov = i0.ɵɵdefineInjectable({ factory: function GoogleTagManagerService_Factory() { return new GoogleTagManagerService(i0.ɵɵinject("googleTagManagerConfig", 8), i0.ɵɵinject("googleTagManagerId", 8), i0.ɵɵinject("googleTagManagerAuth", 8), i0.ɵɵinject("googleTagManagerPreview", 8), i0.ɵɵinject("googleTagManagerResourcePath", 8), i0.ɵɵinject("googleTagManagerCSPNonce", 8)); }, token: GoogleTagManagerService, providedIn: "root" });
GoogleTagManagerService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
/** @nocollapse */
GoogleTagManagerService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerConfig',] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerId',] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerAuth',] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerPreview',] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerResourcePath',] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: ['googleTagManagerCSPNonce',] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItZ29vZ2xlLXRhZy1tYW5hZ2VyL3NyYy9saWIvYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7O0FBTTdELE1BQU0sT0FBTyx1QkFBdUI7SUFZbEMsWUFHUyxTQUFpQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFDSCxrQkFBMEIsRUFHcEUsb0JBQTRCLEVBRzVCLHVCQUErQixFQUcvQiw0QkFBb0MsRUFHcEMsd0JBQWdDO1FBYmhDLFdBQU0sR0FBTixNQUFNLENBQXVDO1FBQ0gsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFRO1FBR3BFLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBUTtRQUc1Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQVE7UUFHL0IsaUNBQTRCLEdBQTVCLDRCQUE0QixDQUFRO1FBR3BDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBUTtRQTNCakMsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUVqQixtQkFBYyxHQUFHO1lBQ3ZCLFNBQVM7Z0JBQ1AsT0FBTyxNQUFNLENBQUM7WUFDaEIsQ0FBQztZQUNELFdBQVc7Z0JBQ1QsT0FBTyxRQUFRLENBQUM7WUFDbEIsQ0FBQztTQUNGLENBQUM7UUFvQkEsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksRUFBRTtZQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDO1NBQzVCO1FBRUQsSUFBSSxDQUFDLE1BQU0sbUNBQ04sSUFBSSxDQUFDLE1BQU0sS0FDZCxFQUFFLEVBQUUsa0JBQWtCLElBQUksSUFBSSxDQUFDLE1B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OlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgR29vZ2xlVGFnTWFuYWdlckNvbmZpZyB9IGZyb20gJy4vZ29vZ2xlLXRhZy1tYW5hZ2VyLWNvbmZpZyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBHb29nbGVUYWdNYW5hZ2VyU2VydmljZSB7XG4gIHByaXZhdGUgaXNMb2FkZWQgPSBmYWxzZTtcblxuICBwcml2YXRlIGJyb3dzZXJHbG9iYWxzID0ge1xuICAgIHdpbmRvd1JlZigpOiBhbnkge1xuICAgICAgcmV0dXJuIHdpbmRvdztcbiAgICB9LFxuICAgIGRvY3VtZW50UmVmKCk6IGFueSB7XG4gICAgICByZXR1cm4gZG9jdW1lbnQ7XG4gICAgfSxcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoJ2dvb2dsZVRhZ01hbmFnZXJDb25maWcnKVxuICAgIHB1YmxpYyBjb25maWc6IEdvb2dsZVRhZ01hbmFnZXJDb25maWcgPSB7IGlkOiBudWxsIH0sXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlcklkJykgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJJZDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlckF1dGgnKVxuICAgIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VyQXV0aDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlclByZXZpZXcnKVxuICAgIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VyUHJldmlldzogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlclJlc291cmNlUGF0aCcpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJSZXNvdXJjZVBhdGg6IHN0cmluZyxcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoJ2dvb2dsZVRhZ01hbmFnZXJDU1BOb25jZScpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJDU1BOb25jZTogc3RyaW5nXG4gICkge1xuICAgIGlmICh0aGlzLmNvbmZpZyA9PSBudWxsKSB7XG4gICAgICB0aGlzLmNvbmZpZyA9IHsgaWQ6IG51bGwgfTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIC4uLnRoaXMuY29uZmlnLFxuICAgICAgaWQ6IGdvb2dsZVRhZ01hbmFnZXJJZCB8fCB0aGlzLmNvbmZpZy5pZCxcbiAgICAgIGd0bV9hdXRoOiBnb29nbGVUYWdNYW5hZ2VyQXV0aCB8fCB0aGlzLmNvbmZpZy5ndG1fYXV0aCxcbiAgICAgIGd0bV9wcmV2aWV3OiBnb29nbGVUYWdNYW5hZ2VyUHJldmlldyB8fCB0aGlzLmNvbmZpZy5ndG1fcHJldmlldyxcbiAgICAgIGd0bV9yZXNvdXJjZV9wYXRoOiBnb29nbGVUYWdNYW5hZ2VyUmVzb3VyY2VQYXRoIHx8IHRoaXMuY29uZmlnLmd0bV9yZXNvdXJjZV9wYXRoXG4gICAgfTtcbiAgICBpZiAodGhpcy5jb25maWcuaWQgPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdHb29nbGUgdGFnIG1hbmFnZXIgSUQgbm90IHByb3ZpZGVkLicpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXREYXRhTGF5ZXIoKTogYW55W10ge1xuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMuYnJvd3Nlckdsb2JhbHMud2luZG93UmVmKCk7XG4gICAgd2luZG93LmRhdGFMYXllciA9IHdpbmRvdy5kYXRhTGF5ZXIgfHwgW107XG4gICAgcmV0dXJuIHdpbmRvdy5kYXRhTGF5ZXI7XG4gIH1cblxuICBwcml2YXRlIHB1c2hPbkRhdGFMYXllcihvYmo6IG9iamVjdCk6IHZvaWQge1xuICAgIGNvbnN0IGRhdGFMYXllciA9IHRoaXMuZ2V0RGF0YUxheWVyKCk7XG4gICAgZGF0YUxheWVyLnB1c2gob2JqKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRHdG1Ub0RvbSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNMb2FkZWQpIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUodGhpcy5pc0xvYWRlZCk7XG4gICAgICB9XG4gICAgICBjb25zdCBkb2MgPSB0aGlzLmJyb3dzZXJHbG9iYWxzLmRvY3VtZW50UmVmKCk7XG4gICAgICB0aGlzLnB1c2hPbkRhdGFMYXllcih7XG4gICAgICAgICdndG0uc3RhcnQnOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcbiAgICAgICAgZXZlbnQ6ICdndG0uanMnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGd0bVNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgIGd0bVNjcmlwdC5pZCA9ICdHVE1zY3JpcHQnO1xuICAgICAgZ3RtU2NyaXB0LmFzeW5jID0gdHJ1ZTtcbiAgICAgIGd0bVNjcmlwdC5zcmMgPSB0aGlzLmFwcGx5R3RtUXVlcnlQYXJhbXMoXG4gICAgICAgIHRoaXMuY29uZmlnLmd0bV9yZXNvdXJjZV9wYXRoID8gdGhpcy5jb25maWcuZ3RtX3Jlc291cmNlX3BhdGggOiAnaHR0cHM6Ly93d3cuZ29vZ2xldGFnbWFuYWdlci5jb20vZ3RtLmpzJ1xuICAgICAgKTtcbiAgICAgIGd0bVNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSh0aGlzLmlzTG9hZGVkID0gdHJ1ZSk7XG4gICAgICB9KTtcbiAgICAgIGd0bVNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChmYWxzZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLmdvb2dsZVRhZ01hbmFnZXJDU1BOb25jZSkge1xuICAgICAgICBndG1TY3JpcHQuc2V0QXR0cmlidXRlKCdub25jZScsIHRoaXMuZ29vZ2xlVGFnTWFuYWdlckNTUE5vbmNlKTtcbiAgICAgIH1cbiAgICAgIGRvYy5oZWFkLmluc2VydEJlZm9yZShndG1TY3JpcHQsIGRvYy5oZWFkLmZpcnN0Q2hpbGQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHB1c2hUYWcoaXRlbTogb2JqZWN0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICghdGhpcy5pc0xvYWRlZCkge1xuICAgICAgICB0aGlzLmFkZEd0bVRvRG9tKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5wdXNoT25EYXRhTGF5ZXIoaXRlbSk7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgfSkuY2F0Y2goKCkgPT4gcmVqZWN0KCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5wdXNoT25EYXRhTGF5ZXIoaXRlbSk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFwcGx5R3RtUXVlcnlQYXJhbXModXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh1cmwuaW5kZXhPZignPycpID09PSAtMSkge1xuICAgICAgdXJsICs9ICc/JztcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgdXJsICtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuY29uZmlnKVxuICAgICAgICAuZmlsdGVyKChrKSA9PiB0aGlzLmNvbmZpZ1trXSlcbiAgICAgICAgLm1hcCgoaykgPT4gYCR7a309JHt0aGlzLmNvbmZpZ1trXX1gKVxuICAgICAgICAuam9pbignJicpXG4gICAgKTtcbiAgfVxufVxuIl19